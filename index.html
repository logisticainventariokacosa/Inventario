<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Logística & Inventario</title>
    <!-- Favicon completo -->
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
<link rel="icon" type="image/x-icon" href="Img/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
<link rel="manifest" href="Img/site.webmanifest">
 
    <style>
/* === VARIABLES DE DISEÑO Y RESET === */
:root{
    --red:#c62828;--black:#121212;--bg:#0f0f0f;
    --text:#fafafa;--muted:#bdbdbd;--card-bg:#161616;
    --card-news:#1b0f0f;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
    font-family:Inter,system-ui, Arial;
    background:
        linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), 
        url('Img/fondo1.jpg') no-repeat fixed center center / cover,
        var(--bg); 
    background-size: cover; 
    color:var(--text);
    min-height:100vh;
    line-height:1.5; 
}

/* === AUTH SCREEN === */
.auth-screen{display:flex;align-items:center;justify-content:center;height:100vh;padding:16px}
.card.auth-card{background:linear-gradient(180deg,#1a1a1a,#0f0f0f);border-radius:12px;padding:28px;width:100%;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,0.04);text-align:center}
.auth-card h1{margin-bottom:6px;font-size:22px}.muted{color:var(--muted)}

/* Contenedor para el input y el botón de toggle (para la contraseña) */
.password-container {
    position: relative;
    width: 100%;
}

.auth-card input{width:100%;padding:10px 12px;margin:8px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}

/* Ajuste para que el input dentro del contenedor de contraseña no tenga doble margen */
.password-container input {
    margin: 8px 0; 
    padding-right: 40px; 
}

/* Estilo para el botón de alternar visibilidad */
.toggle-password {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--muted);
    font-size: 1.1rem;
    padding: 0;
    line-height: 1;
    z-index: 10;
    transition: color 0.2s;
}
.toggle-password:hover {
    color: var(--text);
}


.row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
button{background:var(--red);border:0;padding:10px 14px;border-radius:10px;color:white;cursor:pointer;transition:transform .12s, box-shadow .12s}
button.alt{background:transparent;border:1px solid rgba(255,255,255,0.08)}button.google{background:#fff;color:#222}
button:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(198,40,40,0.12)}
.hidden{display:none}

/* === TOPBAR / NAV MODIFICADO === */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:linear-gradient(90deg,rgba(0,0,0,0.8),rgba(18,18,18,0.9));border-bottom:1px solid rgba(255,255,255,0.03);position:sticky;top:0;z-index:100}
.brand{font-weight:700;color:var(--red);margin-right:10px;font-size:1.1rem}
.nav{display:flex;align-items:center;gap:16px;flex:1;justify-content:space-between;flex-wrap:wrap}

/* Estilo de los botones de navegación */
.nav.menu{display:flex;gap:4px;flex-wrap:wrap;align-items:center}

/* REGLA CRÍTICA: Asegura color blanco y sin subrayado en todos los estados */
.nav .menu a, 
.nav .menu a:visited,
.nav .menu a:link { 
    color:var(--text) !important; 
    text-decoration:none !important; 
    
    padding:8px 12px; 
    border-radius:8px;
    transition:background .2s, color .2s, box-shadow .2s;
    position:relative;
    font-weight:500;
}

/* Estilo para el botón hover (al pasar el ratón) */
.nav .menu a:hover{ 
    color:var(--red) !important; 
    background:rgba(255, 255, 255, 0.05);
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
}

/* Estilo para el botón activo (sección actual) */
.nav .menu a.active{
    color:var(--red) !important; 
    font-weight:700;
    background:rgba(198, 40, 40, 0.1); 
    border: 1px solid rgba(198, 40, 40, 0.3);
    box-shadow: 0 0 10px rgba(198, 40, 40, 0.3); 
}

.nav.user-info{display:flex;align-items:center;gap:10px}
.user-info span{color:var(--muted);font-size:0.95rem;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ghost{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);transition:background .2s}
.ghost:hover{background:rgba(255,255,255,0.1)}

/* === CONTENIDO PRINCIPAL === */
.container{
max-width: 2400px; 
margin: 0 auto; 
padding: 20px 20px 20px 30px; 
display:grid;
grid-template-columns:1fr;
    gap:20px;
}

.section{display:none}.active-section{display:block}

.search-card{background:var(--card-bg);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.search-card h2{margin-bottom:12px}
.search-card input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text);transition:border-color .2s}
.search-card input:focus{border-color:var(--red);outline:none}
.search-card.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.results{margin-top:16px;background:rgba(255,255,255,0.02);border-radius:8px;min-height:40px;overflow-x:auto}
.results table{width:100%;border-collapse:collapse;min-width: 800px;}
.results th,.results td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;vertical-align:middle;font-size:0.9rem}
.results th{color:var(--red);white-space:nowrap;font-weight:600;background:rgba(0,0,0,0.1)}
.results tr:last-child td{border-bottom:none}

/* === GRID GENERAL (Documentos e Imágenes) MODIFICADO === */
.grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); 
    gap:15px;
    margin-top:15px;
}
.card-item{
    background:var(--card-bg);
    padding:15px;
    border-radius:12px;
    text-align:center;
    min-height:180px;
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    border:1px solid rgba(255,255,255,0.05);
    transition:transform .2s, box-shadow .2s;
}
.card-item:hover{
    transform:translateY(-5px);
    box-shadow:0 10px 20px rgba(0,0,0,0.4);
}
.card-item img{
    max-width:100%;
    border-radius:8px;
    height:160px; 
    object-fit:cover;
    background:#111;
    margin-bottom:10px;
    transition:opacity .2s;
}
.card-item a{text-decoration:none}
.card-item a:hover img{opacity:0.9}

/* === NOTICIAS (Sección Inicio) MODIFICADO === */
.news-card-wrapper{
    display:grid;
    grid-template-columns:1fr; 
    gap:15px;
    padding:15px;
    background:var(--card-news);
    border-radius:12px;
    border:1px solid rgba(198,40,40,0.08);
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
    margin-top:20px;
}
.news-card-wrapper h3{
    color:var(--red);
    margin-bottom:5px;
    font-size:1.4rem;
}
.news-image-area{
    text-align:center;
    display:flex;
    flex-direction:column;
    gap:5px;
    align-items:flex-start;
}
.news-image-area img{
    width:100%;
    max-width:280px;
    height:auto;
    max-height:180px;
    object-fit:cover;
    border-radius:8px;
    margin:0; 
}
.news-meta-data{
    font-size:12px;
    color:var(--muted);
    text-align:left;
}
.news-content-area{
    /* Estilos de contenido */
}

/* Desktop: Main News a 2 columnas */
@media(min-width:900px){
    .container{grid-template-columns:1fr 420px}
    .search-card{grid-column:1}
    .news-card-wrapper{
        grid-column:1 / span 2; 
        grid-template-columns: auto 1fr; 
        align-items: flex-start;
    }
    .news-image-area {
        max-width: 300px;
    }
}
@media(min-width:1200px){
     .news-card-wrapper{
        grid-template-columns: 280px 1fr; 
     }
}

/* === NOTICIAS (Sección Noticias) MODIFICADO === */
.news-list .item{
    padding:15px;
    border-radius:12px;
    margin:12px 0;
    background:var(--card-bg);
    border:1px solid rgba(255,255,255,0.05);
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    align-items:flex-start;
}
.news-list .item strong{color:var(--red);font-size:1.1rem}
.news-list .item small{color:var(--muted);display:block;margin-bottom:8px}
.news-list .item p{margin-top:0;font-size:0.95rem}
.news-list .item img{
    width:100%;
    max-width:200px;
    height:120px;
    object-fit:cover;
    border-radius:8px;
    float:left; 
    margin-right:10px;
    margin-bottom:5px;
}

/* Desktop: Lista de noticias a 2 columnas */
@media(min-width:768px){
    .news-list .item{
        grid-template-columns: auto 1fr; 
    }
    .news-list .item img{
        max-width:180px;
        height:100px;
        float:none; 
        margin-right:0;
    }
    .news-list .item div:first-of-type{
        display: flex;
        flex-direction: column;
        padding-left: 10px;
    }
}

/* Placeholder/Inputs/Botones */
.placeholder{
    width:100%;
    height:160px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#0b0b0b;
    color:var(--muted);
    border-radius:8px;
    font-size:14px;
}
input[type=file]{color:var(--muted);margin:8px 0}
.contact-buttons a{display:inline-block;margin:6px 12px 6px 0;padding:10px 14px;background:var(--red);border-radius:10px;color:#fff;text-decoration:none}
.filter-controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:15px;
}
.filter-controls input{
    flex:1;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(255,255,255,0.02);
    color:var(--text);
    min-width:150px;
}

/* 💥 AÑADIDO: Contenedor para el input de filtro y su botón de limpieza 💥 */
.filter-input-group {
    display: flex;
    gap: 5px; /* Espacio entre el input y el botón de limpiar */
    flex: 1; /* Permite que el grupo se estire */
    min-width: 150px; /* Asegura un mínimo en el grupo */
}
.filter-input-group input {
    flex: 1; /* El input toma el espacio restante del grupo */
    margin: 0; /* Eliminar el margen extra para ajustarlo al grupo */
    min-width: 100px; /* Asegura un mínimo para el input */
}
.filter-input-group button.alt {
    padding: 8px 10px; /* Hacer el botón más pequeño y en línea */
    font-size: 0.8rem;
    white-space: nowrap; /* Evita que el texto del botón se rompa */
}


/* Estilo para el campo de texto de las noticias */
#createNewsForm textarea {
    width: 100%;
    padding: 10px 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02);
    color: var(--text);
    height: 120px;
    resize: vertical;
}

/* === MOBILE ADJUSTMENTS - MEJORADO === */
@media(max-width:768px){
    .container {
        padding: 15px;
        grid-template-columns: 1fr;
    }
    
    /* NAVEGACIÓN MEJORADA PARA MÓVIL */
    .topbar {
        padding: 10px 15px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .nav {
        flex-direction: column;
        width: 100%;
        gap: 10px;
    }
    
    .nav.menu {
        order: 2;
        justify-content: flex-start;
        gap: 8px;
        width: 100%;
    }
    
    .nav.user-info {
        order: 1;
        width: 100%;
        justify-content: space-between;
        margin-top: 0;
    }
    
    .brand {
        font-size: 1rem;
        margin-right: 0;
    }
    
    /* MENÚ DE NAVEGACIÓN MÁS COMPACTO */
    .nav .menu a {
        padding: 6px 10px;
        font-size: 0.9rem;
        flex: 1;
        min-width: 0;
        text-align: center;
    }
    
    /* CONTENIDO PRINCIPAL */
    .search-card {
        padding: 15px;
    }
    
    .search-card.row {
        flex-direction: column;
        gap: 8px;
    }
    
    .search-card input {
        width: 100%;
    }
    
    /* TABLA DE RESULTADOS MEJORADA */
    .results {
        overflow-x: auto;
        font-size: 0.8rem;
    }
    
    .results th, .results td {
        padding: 6px 4px;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    /* GRID PARA MÓVIL */
    .grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .card-item {
        min-height: 140px;
        padding: 12px;
    }
    
    .card-item img {
        height: 120px;
    }
    
    /* NOTICIAS EN MÓVIL */
    .news-card-wrapper {
        padding: 12px;
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .news-image-area {
        align-items: center;
        text-align: center;
    }
    
    .news-image-area img {
        max-width: 100%;
        max-height: 150px;
    }
    
    .news-list .item {
        padding: 12px;
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .news-list .item img {
        max-width: 100%;
        height: auto;
        margin: 0 auto 8px;
        display: block;
    }
    
    /* FILTROS MEJORADOS */
    .filter-controls {
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-input-group {
        width: 100%;
    }
    
    .filter-input-group input {
        min-width: 0;
    }
    
    /* BOTONES EN MÓVIL */
    button {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    .row {
        flex-direction: column;
        gap: 8px;
    }
    
    /* FORMULARIOS */
    input, textarea {
        font-size: 16px; /* Previene zoom en iOS */
    }
    
    /* FOOTER */
    .main-footer {
        padding: 10px 15px;
        font-size: 0.8rem;
        text-align: center;
    }
}

/* AJUSTES EXTRA PARA PANTALLAS MUY PEQUEÑAS */
@media(max-width:480px){
    .auth-card {
        padding: 20px;
        margin: 10px;
    }
    
    .nav .menu a {
        padding: 5px 8px;
        font-size: 0.85rem;
    }
    
    .user-info span {
        max-width: 150px;
        font-size: 0.85rem;
    }
    
    .card-item {
        padding: 10px;
    }
    
    .news-card-wrapper h3 {
        font-size: 1.2rem;
    }
}

/* MEJORAS PARA TABLETS */
@media(min-width:769px) and (max-width:1024px){
    .container {
        padding: 20px;
    }
    
    .grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .nav .menu a {
        padding: 6px 10px;
        font-size: 0.9rem;
    }
}

/* === FOOTER (PIE DE PÁGINA) === */
.main-footer{
    display:flex;
    align-items:center;
    justify-content:center; 
    padding:12px 18px;
    background:linear-gradient(90deg,rgba(0,0,0,0.8),rgba(18,18,18,0.9));
    border-top:1px solid rgba(255,255,255,0.03); 
    color:var(--muted); 
    font-size:0.9rem;
    width: 100%;
    margin-top: auto; 
}

</style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
<div id="app">
    <div class="auth-screen" id="authScreen">
        <div class="card auth-card">
            <h1>Logística & Inventario</h1>
            <p class="muted">Accede para información</p>
            <input id="name" placeholder="Nombre"/>
            <input id="email" placeholder="Correo" type="email"/>
            
            <div class="password-container">
                <input id="password" placeholder="Contraseña" type="password"/>
                <button class="toggle-password" id="togglePasswordBtn">👁️</button>
            </div>
            
            <div class="row">
                <button id="btnRegister">Registrarse</button>
                <button id="btnLogin" class="alt">Iniciar sesión</button>
            </div>
            <br>
            <div class="row">
                <button id="btnGoogle" class="google">👤 Iniciar con Google</button>
            </div>
            <br>
            <p class="muted small">Los datos se guardarán en el sistema.</p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="topbar">
            <div style="display:flex;align-items:center;gap:10px">
                <div class="brand">Logística & Inventario</div>
            </div>

            <nav class="nav" aria-label="main navigation">
                <div class="menu">
                    <a href="#" data-section="home" class="active">Inicio</a>
                    <a href="#" data-section="documents">Documentos</a>
                    <a href="#" data-section="images">Imágenes</a>
                    <a href="#" data-section="news">Noticias</a>
                    <a href="#" data-section="contact">Contacto</a>
                </div>
                <div class="user-info">
                    <span id="userEmail"></span>
                    <button id="btnLogout" class="ghost">Cerrar sesión</button>
                </div>
            </nav>
        </header>

        <main class="container">
            
            <section id="home" class="section active-section">
    <div class="search-card">
        <h2>Buscar código en los ultimos conteos fisicos de las tiendas.</h2>

        <div class="row filter-controls" style="margin-bottom:12px;">
             <div class="filter-input-group">
                 <input id="filterCenter" placeholder="Filtrar por Centro de Inventario" />
                 <button id="btnResetFilterCenter" class="alt" data-target="filterCenter">Limpiar</button>
             </div>
             <button id="btnFilterCenter">Aplicar Filtro de Centro</button> 
        </div>

        <div class="row" style="margin-top:8px">
            <input id="searchCode" placeholder="Ingrese código..." />
            <button id="btnSearch">Buscar</button>
        </div>
        <div id="searchResults" class="results"></div>
    </div>
    <div class="news-card-wrapper" id="mainNews"></div>
</section>

            <section id="documents" class="section">
                <h2>Documentos</h2>
                <input type="file" id="docFile"/>
                <input id="docName" placeholder=" * Nombre del archivo" />
                <br>
                <br>
                <button id="btnUploadDoc">Subir documento</button>
                <div id="docStatus"></div>
                
                <h3 style="margin-top:30px;margin-bottom:15px">Archivos subidos</h3>
                <div class="filter-controls">
                    <div class="filter-input-group">
                        <input id="filterNameDoc" placeholder="Filtrar por usuario" />
                        <button id="btnResetFilterNameDoc" class="alt" data-target="filterNameDoc">Limpiar</button>
                    </div>
                    <div class="filter-input-group">
                        <input id="filterEmailDoc" placeholder="Filtrar por correo" />
                        <button id="btnResetFilterEmailDoc" class="alt" data-target="filterEmailDoc">Limpiar</button>
                    </div>
                    <div class="filter-input-group">
                        <input id="filterDateDoc" placeholder="Filtrar por fecha (dd/mm/yyyy)" />
                        <button id="btnResetFilterDateDoc" class="alt" data-target="filterDateDoc">Limpiar</button>
                    </div>

                  <div class="filter-input-group">
                    <input type="text" id="filterFileNameDoc" placeholder="Filtrar por nombre de documento">
                     <button class="alt" id="btnResetFilterFileNameDoc" data-target="filterFileNameDoc">Limpiar</button>
                </div>

                    <button id="btnFilterDoc">Aplicar Filtros</button>
                </div>
                <div id="docList" class="grid"></div>
            </section>

            <section id="images" class="section">
                <h2>Imágenes</h2>
                <input type="file" id="imgFile" accept="image/*"/>
                <input id="imgName" placeholder="* Nombre de la imagen" />
                <br>
                <br>
                <button id="btnUploadImg">Subir imagen</button>
                <div id="imgStatus"></div>
                
                <h3 style="margin-top:30px;margin-bottom:15px">Imágenes subidas</h3>
                <div class="filter-controls">
                    <div class="filter-input-group">
                        <input id="filterNameImg" placeholder="Filtrar por usuario" />
                        <button id="btnResetFilterNameImg" class="alt" data-target="filterNameImg">Limpiar</button>
                    </div>
                    <div class="filter-input-group">
                        <input id="filterEmailImg" placeholder="Filtrar por correo" />
                        <button id="btnResetFilterEmailImg" class="alt" data-target="filterEmailImg">Limpiar</button>
                    </div>
                    <div class="filter-input-group">
                        <input id="filterDateImg" placeholder="Filtrar por fecha (dd/mm/yyyy)" />
                        <button id="btnResetFilterDateImg" class="alt" data-target="filterDateImg">Limpiar</button>
                    </div>

                 <div class="filter-input-group">
                    <input type="text" id="filterFileNameImg" placeholder="Filtrar por nombre de imagen">
                    <button class="alt" id="btnResetFilterFileNameImg" data-target="filterFileNameImg">Limpiar</button>
                </div>

                    <button id="btnFilterImg">Aplicar Filtros</button>
                </div>
                <div id="imgList" class="grid"></div>
            </section>

            <section id="news" class="section">
                <h2>Noticias</h2>
                
                <button id="btnToggleNewsForm" style="margin-bottom: 15px;">CREAR NOTICIA</button>

                <div id="createNewsForm" class="search-card hidden" style="margin-bottom: 30px;">
                    <h3>Publicar Nueva Noticia</h3>
                    
                    <input id="newsTitle" placeholder="* Título de la Noticia" style="margin-bottom: 10px;" />
                    
                    <textarea id="newsContent" placeholder="* Contenido de la Noticia"></textarea>
                    
                    <label for="newsImgFile" style="display: block; margin-top: 10px; color: var(--muted); font-size: 0.9rem;">Imagen (opcional):</label>
                    <input type="file" id="newsImgFile" accept="image/*" style="margin-bottom: 10px;"/>
                    
                    <div class="row" style="justify-content: flex-start; margin-top: 15px;">
                        <button id="btnUploadNews">Publicar Noticia</button>
                        <button id="btnCancelNews" class="alt">Cancelar</button>
                    </div>

                    <div id="newsStatus" style="margin-top: 10px;"></div>
                </div>

                <h3 style="margin-top:20px;margin-bottom:15px">Lista de Noticias</h3>
                
                <div class="filter-controls">
                    <div class="filter-input-group">
                        <input id="filterNewsTitle" placeholder="Filtrar por Título" />
                        <button id="btnResetFilterNewsTitle" class="alt" data-target="filterNewsTitle">Limpiar</button>
                    </div>
                    <div class="filter-input-group">
                        <input id="filterNewsDate" placeholder="Filtrar por Fecha (dd/mm/yyyy)" />
                        <button id="btnResetFilterNewsDate" class="alt" data-target="filterNewsDate">Limpiar</button>
                    </div>
                    <button id="btnFilterNews">Aplicar Filtros</button>
                    <button id="btnResetNewsAll" class="alt">Limpiar filtros</button>
                </div>
                <div id="newsList" class="news-list"></div>
            </section>

            <section id="contact" class="section">
                <h2>Contacto</h2>
                <br>
                <p>Derwin Rojas (Supervisor de inventario)</p>
                <br>
                <div class="contact-buttons">
                    <a id="waBtn" target="_blank">WhatsApp</a>
                    <a id="mailBtn" href="#">Correo</a>
                </div>
            </section>
        </main>
        
        <footer class="main-footer">
            <span>
                Logística & Inventario ©  2025 creado por Derwin Rojas
            </span>
        </footer>
        </div>
    </div>

    <script>
/* ====== CONFIG ====== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzGoWmn4doU1_vDqQvWYbqg4WzW8WD6y64lI96xKYn_bGd-L1THgt3HVJJl_BprqpysTA/exec';

const firebaseConfig = {
    apiKey:"AIzaSyDpBoHiKKC7MLQHiWV9psdE3eJ4YuR66GU",
    authDomain:"pagina-dda30.firebaseapp.com",
    projectId:"pagina-dda30",
    appId:"1:14427407275:web:8cba04677fdeef39a088ee"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// 👉 NUEVA VARIABLE GLOBAL: Almacena los resultados de la búsqueda de código
let currentInventoryResults = [];
// 👉 NUEVA VARIABLE GLOBAL: Almacena las noticias cargadas para poder filtrarlas localmente
let allNewsData = [];

/* ====== Helpers (SIN CAMBIOS EN LA LÓGICA DE URLS) ====== */

function getDriveDirectUrl(url)
{
    if (!url) return '';
    try {
        if (url.includes('uc?export=view') || url.includes('=export')) return url;
        
        let fileId = '';
        const m1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/); 
        const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/); 

        if (m1 && m1[1]) {
            fileId = m1[1];
        } else if (m2 && m2[1]) {
            fileId = m2[1];
        }
        
        if (fileId) {
             return `https://drive.google.com/uc?export=view&id=${fileId}`; 
        }
        return url;
    } catch (e) { return url; }
}

function getDriveThumbnailUrl(url, size = 300) {
    if (!url) return '';
    
    let fileId = '';
    const m1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);

    if (m1 && m1[1]) {
        fileId = m1[1];
    } else if (m2 && m2[1]) {
        fileId = m2[1];
    }
    
    if (!fileId && url.includes('uc?export=view')) {
           const m3 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
           if (m3 && m3[1]) fileId = m3[1];
    }

    if (fileId) {
           return `https://drive.google.com/thumbnail?id=${fileId}&sz=w${size}`; 
    }

    return url;
}

function safeString(v){return v === undefined || v === null ? '' : String(v); }

function getField(obj, ...keys) {
    for (const k of keys)
    {
        if (obj[k] !== undefined && obj[k] !== null) return obj[k];
    }
    const lowerMap = {};
    for (const p in obj) lowerMap[p.toLowerCase().replace(/[\s_]+/g, '')] = obj[p];
    for (const k of keys)
    {
        const low = k.toLowerCase().replace(/[\s_]+/g, ''); 
        if (lowerMap[low] !== undefined) return lowerMap[low];
    }
    return '';
}

/* ====== AUTH (AGREGADO: Lógica de ver/ocultar contraseña) ====== */

// Nuevo listener para el botón de alternar contraseña
document.getElementById('togglePasswordBtn').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    // Cambiar el icono
    this.textContent = type === 'password' ? '👁️' : '🔒'; 
});

auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userEmail').textContent = user.email || user.displayName || '';
        loadNews();
        listUploads('documents');
    } else
    {
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }
});

document.getElementById('btnRegister').addEventListener('click', async () =>
{
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    if (!name || !email || !pass) return alert('Completa todos los campos.');
    try
    {
        const userCred = await auth.createUserWithEmailAndPassword(email, pass);
        await userCred.user.updateProfile({ displayName: name });
        // CORRECCIÓN CLAVE: Pasamos el modo 'cors' para asegurar que se reciba el resultado correcto de la API si fuera necesario.
        await callApi('registerUser', { user: { nombreDeUsuario: name, email, uid: userCred.user.uid } }); 
        alert('Registrado correctamente');
    } catch (err) { alert(err.message); }
});
document.getElementById('btnLogin').addEventListener('click', async () =>
{
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    try
    { await auth.signInWithEmailAndPassword(email, pass); } catch (err) { alert(err.message); }
});
document.getElementById('btnGoogle').addEventListener('click', async () =>
{
    const provider = new firebase.auth.GoogleAuthProvider();
    try
    {
        const res = await auth.signInWithPopup(provider);
        const user = res.user;
        await callApi('registerUser', { user: { nombreDeUsuario: user.displayName, email: user.email, uid: user.uid } });
    } catch (err) { alert(err.message); }
});
document.getElementById('btnLogout').addEventListener('click',
    () => auth.signOut());

/* ====== API Helpers (SIN CAMBIOS) ====== */
async function getApi(action, params = {}) {
    const q = new URLSearchParams(Object.assign({ action }, params)).toString();
    const res = await fetch(API_URL + '?' + q);
    return res.json();
}
async function callApi(action, payload = {}) {
    // MODIFICADO: Ahora incluye 'uploadNews' como una acción sin retorno
    const isNoCors = (action === 'uploadFile' || action === 'addNews' || action === 'registerUser'); 
    const body = JSON.stringify(Object.assign({ action }, payload));
    if (isNoCors) {
        // Usamos 'no-cors' para acciones que no necesitan respuesta del App Script
        // y para evitar problemas de CORS en el registro.
        await fetch(API_URL, { method: 'POST', body, mode: 'no-cors' }); 
        return { ok: true, opaque: true };
    } else
    {
        const res = await fetch(API_URL,
            {
                method:'POST',
                headers: { 'Content-Type': 'application/json' },
                body
            });
        return res.json();
    }
}

// 👉 NUEVA FUNCIÓN: Maneja el renderizado aplicando el filtro de Centro de Inventario
function renderInventoryResults() {
    const out = document.getElementById('searchResults');
    // Usamos 'filterCenter' que es el ID del input 
    const centroFilter = (document.getElementById('filterCenter')?.value || '').trim().toLowerCase(); 
    
    // Aplicar filtro por Centro_Inventario a los resultados YA OBTENIDOS
    const filtered = centroFilter 
        ? currentInventoryResults.filter(r =>
            safeString(getField(r, 'Centro_Inventario', 'centroinventario')).toLowerCase().includes(centroFilter))
        : currentInventoryResults;

    if (!filtered.length) {
        out.innerHTML = '<div class="muted">Sin resultados para este filtro</div>';
        return;
    }

    const rows = filtered.map(r => {
        const codigo = safeString(getField(r, 'codigo', 'Código', 'code')) || '';
        const nombre = safeString(getField(r, 'nombre', 'Nombre', 'name')) || '';
        const descripcion = safeString(getField(r, 'descripcion', 'Descripción', 'description')) || '';
        const um = safeString(getField(r, 'um', 'UM')) || '';
        const ubic = safeString(getField(r, 'ubicacionFisicaGeneral', 'ubicacion')) || '';
        const cantidad = safeString(getField(r, 'cantidad', 'Cant')) || '';
        const ubicExhib = safeString(getField(r, 'ubicacionExhib', 'ubicacion exhib')) || '';
        const conteo = safeString(getField(r, 'conteoExhb', 'conteo exhb')) || '';
        const fechaUlt = safeString(getField(r, 'fechaUltimoConteo', 'fecha')) || '';
        const auditor = safeString(getField(r, 'ultimoAuditor', 'auditor')) || '';
        const difG = safeString(getField(r, 'difGeneral', 'dif_general')) || '';
        const difE = safeString(getField(r, 'difExhib', 'dif_exhib')) || '';
        const centro = safeString(getField(r, 'Centro_Inventario', 'centroinventario')) || '';
        const nombreDoc = safeString(getField(r, 'Nombre_Documento', 'nombredocumento')) || '';

        return `<tr>
            <td>${codigo}</td>
            <td>${nombre}</td>
            <td>${descripcion}</td>
            <td>${um}</td>
            <td>${ubic}</td>
            <td>${cantidad}</td>
            <td>${ubicExhib}</td>
            <td>${conteo}</td>
            <td>${fechaUlt}</td>
            <td>${auditor}</td>
            <td>${difG}</td>
            <td>${difE}</td>
            <td>${centro}</td>
            <td>${nombreDoc}</td>
        </tr>`;
    }).join('');

    out.innerHTML = `<table class="results-table">
        <thead>
            <tr>
                <th>Código</th><th>Nombre</th><th>Descripción</th><th>UM</th>
                <th>Ubicación Física</th><th>Cantidad</th><th>Ubicación Exhib</th><th>Conteo Exhib</th>
                <th>Fecha Último Conteo</th><th>Auditor</th><th>DIF General</th><th>DIF Exhib</th>
                <th>Centro Inventario</th><th>Nombre Documento</th>
            </tr>
        </thead>
        <tbody>${rows}</tbody>
    </table>`;
}

// 👉 MODIFICACIÓN DE LA FUNCIÓN btnSearch
document.getElementById('btnSearch').addEventListener('click', async () =>
{
    const code = document.getElementById('searchCode').value.trim();
    if (!code) return alert('Ingrese un código.');

    document.getElementById('searchResults').innerHTML = '<div class="muted">🔍 Buscando...</div>';
    
    // Eliminamos el filtro de Centro de Inventario de aquí, solo traemos los datos
    
    const data = await getApi('search', { code });

    if (data && data.results && data.results.length)
    {
        // 1. GUARDAMOS LOS RESULTADOS ORIGINALES
        currentInventoryResults = data.results;
        
        // 2. RENDERIZAMOS (APLICANDO EL FILTRO, si ya tiene valor)
        renderInventoryResults();
        
    } else {
        currentInventoryResults = [];
        document.getElementById('searchResults').innerHTML = '<div class="muted">Sin resultados</div>';
    }
});

// 👉 NUEVO: Buscar con Enter en el campo de código
document.getElementById('searchCode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('btnSearch').click();
    }
});

// 👉 NUEVO LISTENER: Conecta el botón de filtrar con la función de renderizado
document.getElementById('btnFilterCenter').addEventListener('click', renderInventoryResults);

// 👉 NUEVO: Filtrar con Enter en el campo de Centro de Inventario
document.getElementById('filterCenter').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        renderInventoryResults();
    }
});

// 👉 NUEVO LISTENER: Limpia el filtro de Centro de Inventario y re-renderiza
document.getElementById('btnResetFilterCenter').addEventListener('click', () => {
    document.getElementById('filterCenter').value = '';
    renderInventoryResults();
});
    
/* ====== UPLOAD helpers (SIN CAMBIOS EN LA BASE) ====== */
async function uploadFile(file, filenameOpt) {
    const base64 = await new Promise(res => {
        const r = new FileReader();
        r.onload = e => res(e.target.result.split(',')[1]);
        r.readAsDataURL(file);
    });
    const uploaderName = auth.currentUser?.displayName || ""; 
    const uploaderEmail = auth.currentUser?.email || "";
    return callApi('uploadFile',
        {
            filename: filenameOpt || file.name,
            mimeType: file.type,
            base64,
            nombreDeUsuario: uploaderName, 
            uploaderEmail 
        });
}

/* Subir documento (CON MODIFICACIÓN: Limpiar campos después de subir) */
document.getElementById('btnUploadDoc').addEventListener('click', async () =>
{
    const f = document.getElementById('docFile');
    const name = document.getElementById('docName').value.trim();
    if (!f.files.length) return alert('Selecciona un archivo');
    if (!name) return alert('El nombre del documento es obligatorio');
    document.getElementById('docStatus').textContent = 'Subiendo...';
    try
    {
        await uploadFile(f.files[0], name);
        document.getElementById('docStatus').textContent = 'Documento subido. Recargando lista...';
        await listUploads('documents');
        document.getElementById('docStatus').textContent = 'Subido: ' + name;
        
        // 👉 NUEVO: Limpiar campos después de subir exitosamente
        document.getElementById('docFile').value = '';
        document.getElementById('docName').value = '';
        
    } catch (e) {
        document.getElementById('docStatus').textContent = 'Error al subir';
        console.error(e);
    }
});

/* Subir imagen (CON MODIFICACIÓN: Limpiar campos después de subir) */
document.getElementById('btnUploadImg').addEventListener('click', async () =>
{
    const f = document.getElementById('imgFile');
    const name = document.getElementById('imgName').value.trim();
    if (!f.files.length) return alert('Selecciona una imagen');
    if (!name) return alert('El nombre de la imagen es obligatorio');
    document.getElementById('imgStatus').textContent = 'Subiendo...';
    try
    {
        await uploadFile(f.files[0], name);
        document.getElementById('imgStatus').textContent = 'Imagen subida. Recargando lista...';
        await listUploads('images');
        document.getElementById('imgStatus').textContent = 'Subido: ' + name;
        
        // 👉 NUEVO: Limpiar campos después de subir exitosamente
        document.getElementById('imgFile').value = '';
        document.getElementById('imgName').value = '';
        
    } catch (e) {
        document.getElementById('imgStatus').textContent = 'Error al subir';
        console.error(e);
    }
});

/* ====== Listado / Render archivos e imágenes (AGREGADO: Lógica de limpieza) ====== */

// Función auxiliar para limpiar un filtro y re-listar
function resetFilter(targetId, section) {
    document.getElementById(targetId).value = '';
    listUploads(section, false, '', true);
}

// Listeners de los botones de Limpiar Filtro - Documentos
document.getElementById('btnResetFilterNameDoc').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'documents'));
document.getElementById('btnResetFilterEmailDoc').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'documents'));
document.getElementById('btnResetFilterDateDoc').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'documents'));
document.getElementById('btnResetFilterFileNameDoc').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'documents'));

// Listeners de los botones de Limpiar Filtro - Imágenes
document.getElementById('btnResetFilterNameImg').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'images'));
document.getElementById('btnResetFilterEmailImg').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'images'));
document.getElementById('btnResetFilterDateImg').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'images'));
document.getElementById('btnResetFilterFileNameImg').addEventListener('click', (e) => resetFilter(e.target.dataset.target, 'images'));

document.getElementById('btnFilterDoc').addEventListener('click', () => listUploads('documents', false, '', true));
document.getElementById('btnFilterImg').addEventListener('click', () => listUploads('images', false, '', true));

// 👉 NUEVO: Aplicar filtros con Enter en todos los campos de filtro de Documentos
document.getElementById('filterNameDoc').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('documents', false, '', true);
    }
});
document.getElementById('filterEmailDoc').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('documents', false, '', true);
    }
});
document.getElementById('filterDateDoc').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('documents', false, '', true);
    }
});
document.getElementById('filterFileNameDoc').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('documents', false, '', true);
    }
});

// 👉 NUEVO: Aplicar filtros con Enter en todos los campos de filtro de Imágenes
document.getElementById('filterNameImg').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('images', false, '', true);
    }
});
document.getElementById('filterEmailImg').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('images', false, '', true);
    }
});
document.getElementById('filterDateImg').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('images', false, '', true);
    }
});
document.getElementById('filterFileNameImg').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        listUploads('images', false, '', true);
    }
});

async function listUploads(section = 'documents', findAndShowName = false, findName = '', showLoading = false)
{
    const docList = document.getElementById('docList');
    const imgList = document.getElementById('imgList');

    // 👉 NUEVO: Mostrar "Filtrando..." si se solicita
    if (showLoading) {
        if (section === 'documents') {
            docList.innerHTML = '<div class="muted">🔍 Filtrando documentos...</div>';
        } else if (section === 'images') {
            imgList.innerHTML = '<div class="muted">🔍 Filtrando imágenes...</div>';
        }
    }

    const res = await getApi('listUploads');
    const docs = res.docs || [];
    const imgs = res.imgs || [];

    let nameFilter, emailFilter, dateFilter, fileNameFilter;

    if (section === 'documents') {
        nameFilter = (document.getElementById('filterNameDoc')?.value || '').trim().toLowerCase();
        emailFilter = (document.getElementById('filterEmailDoc')?.value || '').trim().toLowerCase();
        dateFilter = (document.getElementById('filterDateDoc')?.value || '').trim();
        fileNameFilter = (document.getElementById('filterFileNameDoc')?.value || '').trim().toLowerCase();
    } else if (section === 'images') {
        nameFilter = (document.getElementById('filterNameImg')?.value || '').trim().toLowerCase();
        emailFilter = (document.getElementById('filterEmailImg')?.value || '').trim().toLowerCase();
        dateFilter = (document.getElementById('filterDateImg')?.value || '').trim();
        fileNameFilter = (document.getElementById('filterFileNameImg')?.value || '').trim().toLowerCase();
    } else {
        nameFilter = ''; emailFilter = ''; dateFilter = ''; fileNameFilter = '';
    }
    
    const filterFn = x => {
        const n = (x.uploaderName || '').toString().toLowerCase();
        const e = (x.uploaderEmail || '').toString().toLowerCase();
        const f = (x.name || '').toString().toLowerCase();
        return (
            (!nameFilter || n.includes(nameFilter)) && 
            (!emailFilter || e.includes(emailFilter)) && 
            (!dateFilter || x.date === dateFilter) &&
            (!fileNameFilter || f.includes(fileNameFilter))
        );
    };

    const filteredDocs = docs.filter(filterFn);
    
    // 👉 MODIFICACIÓN CLAVE: Filtrar imágenes que NO empiecen con "NEWS_"
    const filteredImgs = imgs.filter(x => {
        // Excluir imágenes que empiezan con "NEWS_" (imágenes de noticias)
        if (x.name && x.name.startsWith('NEWS_')) {
            return false;
        }
        return filterFn(x);
    });

    // Render documentos
    if (filteredDocs.length)
    {
        docList.innerHTML = filteredDocs.map(d => {
            const direct = getDriveDirectUrl(d.url); 
            return `<div class="card-item">
                <div style="flex:0 0 auto">
                    <a href="${direct}" target="_blank" style="font-weight:bold;color:#cce;font-size:1.1rem">${d.name}</a>
                </div>
                <div style="font-size:0.8rem;color:var(--muted);margin-top:10px">
                    📅 ${safeString(d.date)}<br>👤 ${safeString(d.uploaderName) || 'Sin nombre'}<br>✉️ ${safeString(d.uploaderEmail) || 'Sin correo'}
                </div>
            </div>`;
        }).join('');
    } else
    {
        docList.innerHTML = '<p class="muted">Sin documentos</p>';
    }

    // Render imágenes (lógica de URL de miniatura se mantiene)
    if (filteredImgs.length)
    {
        imgList.innerHTML = filteredImgs.map(i => {
            const thumbnail = getDriveThumbnailUrl(i.url, 400); 
            const directUrl = getDriveDirectUrl(i.url); 
            
            return `<div class="card-item">
                <a href="${directUrl}" target="_blank" style="display:block">
                    <img loading="lazy" src="${thumbnail}" alt="${i.name}" class="card-item-img"
                        onerror="this.onerror=null;this.style.display='none';this.insertAdjacentHTML('afterend','<div class=&quot;placeholder&quot;>Sin miniatura</div>');"
                    />
                </a>
                <div style="margin-top:5px;font-weight:bold;color:#ccc;font-size:1.1rem">${i.name}</div>
                <div style="font-size:0.8rem;color:var(--muted);margin-top:6px">
                    📅 ${safeString(i.date)}<br>👤 ${safeString(i.uploaderName) || 'Sin nombre'}<br>✉️ ${safeString(i.uploaderEmail) || 'Sin correo'}
                </div>
            </div>`;
        }).join('');
    } else
    {
        imgList.innerHTML = '<p class="muted">Sin imágenes</p>';
    }

    if (findAndShowName && findName)
    {
        const allFiles = [...docs, ...imgs];
        const found = allFiles.find(x => x.name === findName);
        if (found) {
            const directUrl = getDriveDirectUrl(found.url);
            const isImg = (found.mime && found.mime.toLowerCase().startsWith('image/')) || /\.(jpg|jpeg|png|gif|webp)$/i.test(found.name);
            if (isImg) document.getElementById('imgStatus').innerHTML = `Subida: <a href="${directUrl}" target="_blank">Abrir</a>`;
            else document.getElementById('docStatus').innerHTML = `Subido: <a href="${directUrl}" target="_blank">Abrir</a>`;
        } else
        {
            document.getElementById('imgStatus').textContent = '';
            document.getElementById('docStatus').textContent = '';
        }
    }
}

/* ====== NEW: News Upload (Formulario) ====== */

// 1. Mostrar/Ocultar el formulario de noticias
document.getElementById('btnToggleNewsForm').addEventListener('click', () => {
    document.getElementById('createNewsForm').classList.toggle('hidden');
    // Limpiar campos al mostrar
    if (!document.getElementById('createNewsForm').classList.contains('hidden')) {
        document.getElementById('newsTitle').value = '';
        document.getElementById('newsContent').value = '';
        document.getElementById('newsImgFile').value = '';
        document.getElementById('newsStatus').textContent = '';
    }
});

document.getElementById('btnCancelNews').addEventListener('click', () => {
    document.getElementById('createNewsForm').classList.add('hidden');
});

// 2. Lógica para subir la Noticia
document.getElementById('btnUploadNews').addEventListener('click', async () =>
{
    const title = document.getElementById('newsTitle').value.trim();
    const content = document.getElementById('newsContent').value.trim();
    const imgFile = document.getElementById('newsImgFile').files[0];
    const status = document.getElementById('newsStatus');

    if (!title || !content) return alert('El Título y el Contenido son obligatorios.');

    status.textContent = 'Subiendo noticia...';

    let imageUrl = '';

    try
    {
        // 1. Subir la imagen si existe
        if (imgFile) {
            status.textContent = 'Subiendo imagen...';
            // Usamos un nombre único para la imagen de noticia para evitar colisiones
            const imgName = `NEWS_${Date.now()}_${imgFile.name}`; 
            
            // Llama al Apps Script para subir la imagen a Drive/Sheet de archivos
            await uploadFile(imgFile, imgName);

            // Dado que 'uploadFile' usa 'mode: no-cors', necesitamos un paso adicional para obtener el URL
            // Hacemos una nueva llamada a la API para obtener el listado de imágenes y buscar la recién subida
            const listRes = await getApi('listUploads');
            const uploadedImg = (listRes.imgs || []).find(x => x.name === imgName);
            if (uploadedImg && uploadedImg.url) {
                imageUrl = uploadedImg.url;
            } else {
                status.textContent = 'Error: No se pudo obtener el URL de la imagen. La noticia se publicará sin ella.';
                console.warn('Could not retrieve image URL after upload.');
            }
        }
        
        // 2. Publicar la noticia con los datos (y el URL de la imagen)
        status.textContent = 'Publicando noticia..';
        
        const newsData = {
            titulo: title,
            contenido: content,
            imagenUrl: imageUrl,
        };

        // Nueva acción en Apps Script: 'addNews'
        await callApi('addNews', { news: newsData });

        status.textContent = '✅ Noticia publicada exitosamente. Recargando lista...';
        
        // Limpiar formulario y recargar noticias
        document.getElementById('createNewsForm').classList.add('hidden');
        await loadNews();

    } catch (e) {
        status.textContent = '❌ Error al publicar la noticia.';
        console.error(e);
    }
});

/* ====== Noticias (LÓGICA MEJORADA PARA MOSTRAR Y FILTRAR) ====== */

function renderNews(newsArray) {
    const main = document.getElementById('mainNews');
    const list = document.getElementById('newsList');

    if (newsArray.length === 0) {
        main.innerHTML = '<p class="muted">No se han publicado noticias.</p>';
        list.innerHTML = '';
        return;
    }

    // 1. Renderizado de la NOTICIA PRINCIPAL (si hay resultados)
    const n = newsArray[0];
    const imgUrl = getDriveThumbnailUrl(safeString(n.imagenUrl), 300); 
    const directLink = getDriveDirectUrl(safeString(n.imagenUrl));

    main.innerHTML = `
        <div class="news-image-area">
            ${imgUrl 
                ? `<a href="${directLink}" target="_blank"><img loading="lazy" src="${imgUrl}" alt="noticia" class="news-card-img" 
                    onerror="this.style.display='none'; this.alt='No image'"></a>` 
                : ''}
            <div class="news-meta-data">
                📅 ${safeString(n.fecha)}
            </div>
        </div>
        <div class='news-content-area'>
            <h3>${safeString(n.titulo)}</h3>
            <p style="margin-top:10px">${safeString(n.contenido)}</p>
        </div>
        `; 

    // 2. Renderizado de la LISTA DE NOTICIAS
    list.innerHTML = newsArray.map(x => {
        const thumb = getDriveThumbnailUrl(safeString(x.imagenUrl), 200); 
        const directLinkItem = getDriveDirectUrl(safeString(x.imagenUrl));
        
        return `<div class="item">
            <a href="${directLinkItem}" target="_blank">
            ${thumb
                ? `<img loading="lazy" src="${thumb}" alt="${safeString(x.titulo)}" class="news-list-thumb"
                    onerror="this.style.display='none'; this.alt='No image'">`
                : ''}
            </a>
            <div>
                <strong>${safeString(x.titulo)}</strong>
                <small>${safeString(x.fecha)}</small>
                <p>${safeString(x.contenido)}</p> 
            </div>
        </div>`;
    }).join('');
}

async function loadNews(){
    const res = await getApi('listNews');
    
    // Almacena los resultados originales de la API
    allNewsData = (res && res.news && res.news.length) ? res.news : [];
    
    // Renderiza la lista completa inicialmente
    renderNews(allNewsData);
}

// 3. NEW: News Filtering Logic
function filterNews() {
    const titleFilter = (document.getElementById('filterNewsTitle')?.value || '').trim().toLowerCase();
    const dateFilter = (document.getElementById('filterNewsDate')?.value || '').trim();

    const filteredNews = allNewsData.filter(n => {
        const title = (n.titulo || '').toString().toLowerCase();
        const date = (n.fecha || '').toString().trim();
        
        return (
            (!titleFilter || title.includes(titleFilter)) && 
            // Buscamos si la fecha empieza con el filtro (útil para buscar por dd/mm o dd/mm/yyyy)
            (!dateFilter || date.startsWith(dateFilter))
        );
    });

    renderNews(filteredNews);
}

// 4. NEW: Listeners para los filtros y limpieza
document.getElementById('btnFilterNews').addEventListener('click', filterNews);

// 👉 NUEVO: Filtrar noticias con Enter
document.getElementById('filterNewsTitle').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        filterNews();
    }
});
document.getElementById('filterNewsDate').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        filterNews();
    }
});

// Limpiar filtro individual de Título
document.getElementById('btnResetFilterNewsTitle').addEventListener('click', (e) => {
    document.getElementById(e.target.dataset.target).value = '';
    filterNews(); 
});

// Limpiar filtro individual de Fecha
document.getElementById('btnResetFilterNewsDate').addEventListener('click', (e) => {
    document.getElementById(e.target.dataset.target).value = '';
    filterNews(); 
});

// Limpiar TODOS los filtros de Noticias
document.getElementById('btnResetNewsAll').addEventListener('click', () => {
    document.getElementById('filterNewsTitle').value = '';
    document.getElementById('filterNewsDate').value = '';
    renderNews(allNewsData); // Muestra todos los resultados almacenados
});


/* ====== Navegación (SIN CAMBIOS EN LÓGICA) ====== */
document.querySelectorAll('.nav a').forEach(a => {
    a.addEventListener('click', e =>
    {
        e.preventDefault();
        document.querySelectorAll('.nav a').forEach(n => n.classList.remove('active'));
        a.classList.add('active');
        const target = a.dataset.section;
        document.querySelectorAll('.section').forEach(s => s.id === target ? s.classList.add('active-section') : s.classList.remove('active-section'));
        if (target === 'documents') listUploads('documents'); 
        if (target === 'images') listUploads('images'); 
    });
});

/* ====== Contacto (SIN CAMBIOS) */
document.getElementById('waBtn').href = "https://wa.me/4129915255?text=Hola%20";
document.getElementById('mailBtn').href = "mailto:derwins.rojas@kacosa.com";

/* ====== Inicial (SIN CAMBIOS) ====== */
setTimeout(() => {if (auth.currentUser) { listUploads('documents'); listUploads('images'); loadNews(); } }, 800);

// 👉 NUEVO: Limpiar resultados cuando la barra de búsqueda quede vacía
document.getElementById('searchCode').addEventListener('input', function() {
    const code = this.value.trim();
    if (!code) {
        // Si la barra de búsqueda está vacía, limpiar los resultados
        currentInventoryResults = [];
        document.getElementById('searchResults').innerHTML = '';
    }
});

// 👉 NUEVO: Limpiar resultados filtrados cuando el filtro de Centro quede vacío
document.getElementById('filterCenter').addEventListener('input', function() {
    const filterValue = this.value.trim();
    if (!filterValue && currentInventoryResults.length > 0) {
        // Si el filtro está vacío pero hay resultados, mostrar todos los resultados nuevamente
        renderInventoryResults();
    }
});

// 👉 NUEVO: Limpiar resultados cuando los filtros de nombre de archivo queden vacíos
document.getElementById('filterFileNameDoc').addEventListener('input', function() {
    const filterValue = this.value.trim();
    if (!filterValue) {
        listUploads('documents', false, '', true);
    }
});

document.getElementById('filterFileNameImg').addEventListener('input', function() {
    const filterValue = this.value.trim();
    if (!filterValue) {
        listUploads('images', false, '', true);
    }
});

</script>

</body>
</html>
